name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  lint-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install
      - name: Lint frontend
        run: pnpm lint

  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install
      - name: Run frontend tests
        run: pnpm test run

  lint-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Checkout arcadia-extension-framework
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/arcadia-extension-framework
          path: arcadia-extension-framework
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Lint backend
        working-directory: src-tauri
        run: cargo clippy -- -D warnings

  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Checkout arcadia-extension-framework
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/arcadia-extension-framework
          path: arcadia-extension-framework
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Run backend tests
        working-directory: src-tauri
        run: cargo test

  build-tauri:
    needs: [lint-frontend, test-frontend, lint-backend, test-backend]
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.platform }}
    env:
      PKG_CONFIG_PATH: /usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/x86_64-linux-gnu/pkgconfig
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Checkout arcadia-extension-framework
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/arcadia-extension-framework
          path: arcadia-extension-framework
      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: "pnpm"
      - name: Install dependencies
        run: pnpm install
      - name: Set up Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Install system dependencies (Linux)
        if: matrix.platform == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y libglib2.0-dev libgtk-3-dev libwebkit2gtk-4.0-dev pkg-config

      - name: Set PKG_CONFIG_PATH (Linux)
        if: matrix.platform == 'ubuntu-latest'
        run: echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/x86_64-linux-gnu/pkgconfig" >> $GITHUB_ENV
      - name: Install system dependencies (macOS)
        if: matrix.platform == 'macos-latest'
        run: brew install glib pkg-config
      - name: Set PKG_CONFIG_PATH (macOS)
        if: matrix.platform == 'macos-latest'
        run: echo "PKG_CONFIG_PATH=$(brew --prefix)/opt/glib/lib/pkgconfig" >> $GITHUB_ENV
      - name: Verify system dependencies
        run: |
          echo "Checking pkg-config setup..."
          echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
          pkg-config --libs --cflags glib-2.0 gobject-2.0 gio-2.0 || echo "pkg-config failed to find libraries"
          echo "glib-2.0 version: $(pkg-config --modversion glib-2.0 2>/dev/null || echo 'not found')"
          echo "gobject-2.0 version: $(pkg-config --modversion gobject-2.0 2>/dev/null || echo 'not found')"
          echo "gio-2.0 version: $(pkg-config --modversion gio-2.0 2>/dev/null || echo 'not found')"
      - name: Install Tauri CLI
        run: cargo install tauri-cli
      - name: Build frontend
        run: PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/x86_64-linux-gnu/pkgconfig pnpm build
      - name: Build Tauri app
        run: PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/x86_64-linux-gnu/pkgconfig pnpm tauri build

  build-tauri-docker:
    needs: [lint-frontend, test-frontend, lint-backend, test-backend]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Checkout arcadia-extension-framework
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/arcadia-extension-framework
          path: arcadia-extension-framework
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/arcadia-app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
